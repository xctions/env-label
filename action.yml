name: "Extract Env Label"
description: "A custom action to update a yaml property and create a PR if updated."

inputs:
  token:
    description: "GitHub token"
    required: true
  pr_number:
    description: "PR number"
    required: true
  repository:
    description: "Repository"
    required: true
outputs:
  env:
    value: ${{ steps.filter-labels.outputs.env }}
    description: "Environment label"
runs:
  using: composite
  steps:

    - name: Checkout repository
      uses: actions/checkout@v2

    - uses: xctions/env-label/actions/log@main

    - name: Fetch labels that a given PR has
      id: fetch-labels
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
      run: |
        labels_json=$(gh api "repos/xctions/xctions-tests/issues/21/labels")
        INFO "labels_json: $labels_json"

        filtered_labels=$(echo "$labels_json" | jq -r '[.[] | select(.name == "dev" or .name == "test" or .name == "stag" or .name == "qa" or .name == "prod") | .name]')
        INFO "filtered_labels: $filtered_labels"

        echo "labels=$filered_labels" >> $GITHUB_OUTPUT

    - name: Filter env labels
      id: filter-labels
      shell: bash
      env: 
        LABELS: ${{ steps.fetch-labels.outputs.labels }}
      run: |
        len=$(echo "$LABELS" | jq 'length')
        INFO "len: $len"

        if [ "$len" -ne 1 ]; then
          ERR "Error: Expected exactly one environment label, but found $len"
          exit 1
        fi

        env=$(echo "$labels" | jq -r '.[0]')
        INFO "Environment label: $env"
        echo "env=$output" >> $GITHUB_OUTPUT
