name: "Extract Env Label"
description: "A custom action to update a yaml property and create a PR if updated."

inputs:
  token:
    description: "GitHub token"
    required: true
  pr_number:
    description: "PR number"
    required: true
  repository:
    description: "Repository"
    required: true
outputs:
  env:
    value: ${{ steps.filter-labels.outputs.env }}
    description: "Environment label"
runs:
  using: composite
  steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Fetch labels that a given PR has
      id: fetch-labels
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
      run: |
        labels=$(gh api "repos/${{ inputs.repository }}/issues/${{ inputs.pr_number }}/labels" --jq \
            '.[].name'
        )

        labels=$(echo "$labels" | jq -r \
            'map(select(. == "dev" or . == "test" or . == "stag" or . == "qa" or . == "prod"))'
        )

        echo "labels=$labels" >> $GITHUB_OUTPUT

    - name: Filter env labels
      id: filter-labels
      shell: bash
      env: 
        LABELS: ${{ steps.fetch-labels.outputs.labels }}
      run: |
        len=$(echo "$LABELS" | jq 'length')
        echo "len=$len"

        if [ "$len" -ne 1 ]; then
          echo "Error: Expected exactly one environment label, but found $len"
          exit 1
        fi

        env=$(echo "$labels" | jq -r '.[0]')

        echo "env=$output" >> $GITHUB_OUTPUT
